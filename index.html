<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Fake Product Identification - With Packed Photo</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.7.4/dist/web3.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://unpkg.com/nft.storage/dist/bundle.js"></script>
  <style>
    body { background: #262642; font-family: Montserrat, Arial, sans-serif; margin: 0; color: #eee; min-height: 100vh;}
    .container { background: #1e1e2f; max-width: 600px; margin: 32px auto; padding: 28px 22px; border-radius: 14px; box-shadow: 0 8px 32px #000a; }
    h1 { text-align: center; color: #ff6f61; margin-bottom: 24px;}
    .section { margin-bottom: 30px; background: #292944; border-radius:12px; box-shadow: 0 5px 15px #0009; padding: 18px 16px;}
    label { font-weight: bold; margin-right: 6px; }
    input, button { border-radius: 7px; font-size: 1rem; }
    input[type="text"], input[type="date"] { width:98%; padding:9px 12px; border: none; margin-bottom: 8px;}
    input[type="file"]::-webkit-file-upload-button { cursor:pointer; }
    input[type="file"] { background:#eee; color:#222; padding: 7px;}
    button { background:#ff6f61; color:#fff; border:none; font-weight: bold; padding: 10px 0; width:100%; margin-top:12px; cursor:pointer;}
    button:disabled { background: #a94c43; }
    .success { background: #39e2a0ee; color: #062; padding:12px; margin-top:9px; border-radius:8px;}
    .error   { background: #fb5858dd; color: #391313; padding:12px; margin-top:9px; border-radius:8px;}
    #walletAddress { text-align:center; color:#ffe7ba; margin-bottom:20px;}
    #qr-reader { margin: 20px 0 8px 0; }
    .flash-toggle { background:#ffa17f; color:#444; text-align:center; margin:14px auto 0 auto; border-radius:100px; font-weight:700; padding:8px 0; width:70%; cursor:pointer; }
    img.prod-image { max-width: 180px; border-radius:9px; margin:8px 0 10px 0; border:2px solid #fff3; box-shadow:0 4px 12px #111a;}
    @media(max-width:625px){ .container {padding:12px;} }
  </style>
</head>
<body>
<div class="container">
  <h1>Fake Product Identification</h1>
  <button id="connectWalletBtn">üîó Connect Wallet</button>
  <div id="walletAddress"></div>

  <div class="section">
    <h2>Register New Product</h2>
    <form id="registration-form" novalidate>
      <label for="reg-productId">Product ID</label>
      <input type="text" id="reg-productId" name="productId" required/>
      <label for="reg-name">Product Name</label>
      <input type="text" id="reg-name" name="name" required/>
      <label for="reg-manufacturer">Manufacturer</label>
      <input type="text" id="reg-manufacturer" name="manufacturer" required/>
      <label for="reg-manufactureDate">Manufacture Date</label>
      <input type="date" id="reg-manufactureDate" name="manufactureDate" required/>
      <label for="reg-photo">Photo When Packed</label>
      <input type="file" accept="image/*" id="reg-photo" required />
      <button type="submit" id="register-btn">Register Product</button>
    </form>
    <div id="registration-result"></div>
  </div>

  <div class="section">
    <h2>Verify Product</h2>
    <label for="verify-productId">Product ID (scan from phone body/enter)</label>
    <input type="text" id="verify-productId" placeholder="Scan or enter product ID"/>
    <button id="verify-btn" disabled>Verify Product</button>
    <div id="verification-result"></div>
    <div id="qr-result"></div>
    <div id="qr-reader"></div>
    <div class="flash-toggle" id="flash-toggle" tabindex="0" aria-pressed="false" style="display:none">üî¶ Toggle Flashlight</div>
    <div id="user-report-section" style="display:none;margin-top:15px;">
      <label for="user-report">Describe any issues:</label>
      <input type="text" id="user-report" placeholder="e.g. wrong model, damaged, box opened">
      <button id="report-btn">Report to Flipkart</button>
      <div id="report-result"></div>
    </div>
    <button id="save-proof-btn" style="display:none;margin-top:10px;">Download Verification Proof</button>
  </div>
</div>
<script>
/==== CONTRACT SETTINGS ===========/
// Replace with your real contract ABI and address:
const contractABI = [ 
  {
    "inputs": [
      {"internalType": "string", "name": "productId", "type": "string"},
      {"internalType": "string", "name": "name", "type": "string"},
      {"internalType": "string", "name": "manufacturer", "type": "string"},
      {"internalType": "uint256", "name": "manuDate", "type": "uint256"},
      {"internalType": "string", "name": "imageHash", "type": "string"}
    ],
    "name": "registerProduct",
    "outputs": [],
    "stateMutability": "nonpayable", "type": "function"
  },
  {
    "inputs": [{ "internalType": "string", "name": "productId", "type": "string" }],
    "name": "verifyProduct",
    "outputs": [
      { "internalType": "bool", "name": "exists", "type": "bool" },
      { "internalType": "string", "name": "name", "type": "string" },
      { "internalType": "string", "name": "manufacturer", "type": "string" },
      { "internalType": "string", "name": "imageHash", "type": "string" }
    ],
    "stateMutability": "view", "type": "function"
  },
  {
    "inputs": [
      { "internalType": "string", "name": "productId", "type": "string" },
      { "internalType": "string", "name": "remarks", "type": "string" }
    ],
    "name": "logReport",
    "outputs": [],
    "stateMutability": "nonpayable", "type": "function"
  }
];
const contractAddress = "0x0fC5025C764cE34df352757e82f7B5c4Df39A836"; // UPDATE!
const NFT_STORAGE_TOKEN = "YOUR_NFT_STORAGE_API_KEY"; // GET FROM https://nft.storage/
/============================/

let web3, contract, userAccount, scanner, currentCameraId, flashOn = false;

document.getElementById("connectWalletBtn").onclick = async () => {
  if (window.ethereum) {
    try {
      web3 = new Web3(window.ethereum);
      const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
      userAccount = accounts[0];
      contract = new web3.eth.Contract(contractABI, contractAddress);
      document.getElementById("walletAddress").innerText = "Connected: " + userAccount;
      document.getElementById("verify-btn").disabled = false;
    } catch (err) {
      alert("User denied wallet connection.");
    }
  } else {
    alert("Please install MetaMask.");
  }
};

// Registration with packed photo
document.getElementById("registration-form").onsubmit = async (e) => {
  e.preventDefault();
  const productId = document.getElementById('reg-productId').value.trim();
  const name      = document.getElementById('reg-name').value.trim();
  const manu      = document.getElementById('reg-manufacturer').value.trim();
  const date      = document.getElementById('reg-manufactureDate').value;
  const photoFile = document.getElementById('reg-photo').files[0];
  const resultDiv = document.getElementById("registration-result");
  const timestamp = Math.floor(new Date(date).getTime() / 1000);
  resultDiv.textContent = ""; resultDiv.className = "";
  if (!productId || !name || !manu || !date) {
    resultDiv.textContent = "‚ùå Please fill all fields.";
    resultDiv.className = "error"; return;
  }
  if (!photoFile) {
    resultDiv.textContent = "‚ùå Please upload the product photo!";
    resultDiv.className = "error"; return;
  }
  let imageHash;
  try {
    const client = new NFTStorage.NFTStorage({ token: NFT_STORAGE_TOKEN });
    imageHash = await client.storeBlob(photoFile); // returns IPFS hash
  } catch (err) {
    resultDiv.textContent = "‚ùå Failed to upload image to IPFS.";
    resultDiv.className = "error";
    return;
  }
  try {
    await contract.methods.registerProduct(productId, name, manu, timestamp, imageHash)
      .send({ from: userAccount });
    resultDiv.textContent = "‚úÖ Product Registered!";
    resultDiv.className = "success";
    e.target.reset();
  } catch (err) {
    resultDiv.textContent = "‚ùå Registration failed.";
    resultDiv.className = "error";
  }
};

document.getElementById("verify-btn").onclick = async () => {
  const pid = document.getElementById("verify-productId").value.trim();
  const resultDiv = document.getElementById("verification-result");
  const saveBtn = document.getElementById("save-proof-btn");
  const userReportSec = document.getElementById("user-report-section");
  resultDiv.textContent = ""; resultDiv.className = "";
  saveBtn.style.display = "none"; userReportSec.style.display = "none";
  if (!pid) {
    resultDiv.textContent = "‚ùå Please enter or scan a product ID.";
    resultDiv.className = "error";
    return;
  }
  try {
    const res = await contract.methods.verifyProduct(pid).call({ from: userAccount });
    if (res[0]) {
      // res = [exists, name, manufacturer, imageHash]
      resultDiv.innerHTML = `
        ‚úÖ <strong>Valid Product</strong><br>
        <strong>Name:</strong> ${res[1]}<br>
        <strong>Manufacturer:</strong> ${res[2]}<br>
        ${res[3] ? <img src="<https://ipfs.io/ipfs/${res>[3]}" alt="Packed Product Photo" class="prod-image"/><br> : ""}
        <span style="color:#ffe089;">Check this image: Was your delivered phone/packing exactly like this? If not, report below.</span>
      `;
      resultDiv.className = "success";
      setTimeout(()=>{userReportSec.style.display = "block"; saveBtn.style.display = "inline-block";},500);
    } else {
      resultDiv.textContent = "‚ùå Product not found! Please refuse delivery or scan from your phone's body QR/serial.";
      resultDiv.className = "error";
    }
  } catch (err) {
    resultDiv.textContent = "‚ùå Error verifying product.";
    resultDiv.className = "error";
  }
};

document.getElementById("save-proof-btn").onclick = function() {
  const prodId = document.getElementById("verify-productId").value;
  const verified = document.getElementById("verification-result").innerText;
  const time = new Date().toLocaleString();
  const content = Verification for Product ID: ${prodId}\n${verified}\nChecked at: ${time};
  const blob = new Blob([content], {type:'text/plain'});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = product-verification-${prodId}.txt;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
};

document.getElementById("report-btn").onclick = async () => {
  const productId = document.getElementById("verify-productId").value.trim();
  const remarks   = document.getElementById("user-report").value.trim();
  const resDiv    = document.getElementById("report-result");
  resDiv.textContent = ""; resDiv.className = "";
  if (!remarks) {
    resDiv.textContent = "Please describe the issue!";
    return;
  }
  try {
    await contract.methods.logReport(productId, remarks).send({from:userAccount});
    resDiv.textContent = "‚úÖ Submitted! Support will contact you if needed.";
    resDiv.className = "success";
  } catch(e) {
    resDiv.textContent = "‚ùå Failed submitting! Please try again.";
    resDiv.className = "error";
  }
};

async function startScanner() {
  scanner = new Html5Qrcode("qr-reader");
  try {
    const devices = await Html5Qrcode.getCameras();
    if (devices && devices.length) {
      const backCam = devices.find(cam => cam.label.toLowerCase().includes("back")) || devices[0];
      currentCameraId = backCam.id;
      await scanner.start(
        { deviceId: { exact: currentCameraId } },
        { fps: 12, qrbox: 190 },
        (decodedText) => {
          document.getElementById("verify-productId").value = decodedText;
          document.getElementById("verify-btn").click();
          document.getElementById("qr-result").textContent = "üì¶ QR Scanned: "+decodedText;
        },
        ()=>{} // ignore scan errors
      );
      const caps = await scanner.getRunningTrackCapabilities?.();
      if (caps && caps.torch) document.getElementById("flash-toggle").style.display = "block";
    } else {
      document.getElementById("qr-result").innerText = "‚ùå No camera found!";
    }
  } catch (err) {
    document.getElementById("qr-result").innerText = "‚ùå Unable to access camera.";
  }
};
document.getElementById("flash-toggle").onclick = async () => {
  if (scanner && currentCameraId) {
    flashOn = !flashOn;
    try {
      await scanner.applyVideoConstraints({ advanced: [{ torch: flashOn }] });
      document.getElementById("flash-toggle").setAttribute("aria-pressed", flashOn);
    } catch (err) { alert("‚ö† Flashlight not supported on this device."); }
  }
};
window.onload = startScanner;
</script>
</body>
</html>
