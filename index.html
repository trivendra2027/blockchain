<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Blockchain Product Registry</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.7.4/dist/web3.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      padding: 0;
    }
    h1, h2 {
      text-align: center;
    }
    form {
      max-width: 400px;
      margin: 0 auto 20px auto;
      display: flex;
      flex-direction: column;
    }
    input, button {
      margin: 5px 0;
      padding: 10px;
    }
    #qr-reader {
      width: 100%;
      margin: 20px auto;
    }
    .status {
      text-align: center;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h1>Blockchain Product Registry</h1>

  <button onclick="connectWallet()">üîó Connect Wallet</button>
  <div id="walletAddress" class="status"></div>

  <h2>Scan QR / Barcode</h2>
  <div id="qr-reader"></div>
  <div id="qr-result" class="status"></div>

  <h2>Register Product</h2>
  <form id="registerForm">
    <input type="text" id="productId" placeholder="Product ID (scanned or manual)" required />
    <input type="text" id="productName" placeholder="Product Name" required />
    <input type="text" id="manufacturer" placeholder="Manufacturer" required />
    <input type="date" id="registrationDate" required />
    <input type="text" id="otp" placeholder="OTP" required />
    <input type="file" id="file" required />
    <button type="button" onclick="generateOTP()">Generate OTP</button>
    <button type="submit">Register Product</button>
  </form>

  <h2>Verify Product</h2>
  <form id="verifyForm">
    <input type="text" id="verifyProductId" placeholder="Product ID" required />
    <input type="text" id="verifyOtp" placeholder="OTP" required />
    <button type="submit">Verify Product</button>
  </form>

  <div id="result" class="status"></div>

  <script>
    const contractAddress = '0xcf793e230f11ce3042aeadd1ca72e86c1dfd533e';
    const abi = [
      {"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"productId","type":"string"},{"indexed":true,"internalType":"address","name":"owner","type":"address"}],"name":"ProductRegistered","type":"event"},
      {"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"productId","type":"string"},{"indexed":false,"internalType":"bool","name":"valid","type":"bool"}],"name":"ProductVerified","type":"event"},
      {"inputs":[{"internalType":"string","name":"_productId","type":"string"},{"internalType":"string","name":"_otp","type":"string"},{"internalType":"string","name":"_fileHash","type":"string"}],"name":"registerProduct","outputs":[],"stateMutability":"nonpayable","type":"function"},
      {"inputs":[{"internalType":"string","name":"_productId","type":"string"}],"name":"getFileHash","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"string","name":"_productId","type":"string"}],"name":"getOwner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"string","name":"","type":"string"}],"name":"products","outputs":[{"internalType":"string","name":"productId","type":"string"},{"internalType":"string","name":"otp","type":"string"},{"internalType":"string","name":"fileHash","type":"string"},{"internalType":"address","name":"owner","type":"address"}],"stateMutability":"view","type":"function"},
      {"inputs":[{"internalType":"string","name":"_productId","type":"string"},{"internalType":"string","name":"_otp","type":"string"}],"name":"verifyProduct","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"}
    ];

    let account;
    let contract;

    async function connectWallet() {
      if (window.ethereum) {
        try {
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          account = accounts[0];
          document.getElementById('walletAddress').innerText = `Connected Wallet: ${account}`;
          const web3 = new Web3(window.ethereum);
          contract = new web3.eth.Contract(abi, contractAddress);
        } catch (err) {
          alert('Wallet connection failed.');
        }
      } else {
        alert('MetaMask not found.');
      }
    }

    function generateOTP() {
      const otp = Math.floor(100000 + Math.random() * 900000);
      document.getElementById('otp').value = otp;
    }

    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const productId = document.getElementById('productId').value;
      const otp = document.getElementById('otp').value;
      const file = document.getElementById('file').files[0];

      if (!file) return alert('Please upload a file.');

      const reader = new FileReader();
      reader.onload = async (event) => {
        const fileHash = Web3.utils.sha3(event.target.result);
        try {
          await contract.methods.registerProduct(productId, otp, fileHash).send({ from: account });
          document.getElementById('result').innerText = '‚úÖ Product Registered Successfully';
        } catch (err) {
          console.error(err);
          document.getElementById('result').innerText = '‚ùå Registration Failed. Check console.';
        }
      };
      reader.readAsArrayBuffer(file);
    });

    document.getElementById('verifyForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const productId = document.getElementById('verifyProductId').value;
      const otp = document.getElementById('verifyOtp').value;
      try {
        const isValid = await contract.methods.verifyProduct(productId, otp).call();
        document.getElementById('result').innerText = isValid ? '‚úÖ Product is Authentic' : '‚ùå Invalid Product or OTP';
      } catch (err) {
        console.error(err);
        document.getElementById('result').innerText = '‚ùå Verification Failed';
      }
    });

    function onScanSuccess(decodedText) {
      document.getElementById('qr-result').innerText = `Scanned: ${decodedText}`;
      document.getElementById('productId').value = decodedText;
    }

    const qrScanner = new Html5QrcodeScanner('qr-reader', {
      fps: 10,
      qrbox: 250,
      rememberLastUsedCamera: true,
    });
    qrScanner.render(onScanSuccess);
  </script>
</body>
</html>
