<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Fake Product Identification - With Packed Photo & Camera Access</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.7.4/dist/web3.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://unpkg.com/nft.storage/dist/bundle.js"></script>
  <style>
    body { background: #262642; font-family: Montserrat, Arial, sans-serif; margin: 0; color: #eee; min-height: 100vh;}
    .container { background: #1e1e2f; max-width: 600px; margin: 32px auto; padding: 28px 22px; border-radius: 14px; box-shadow: 0 8px 32px #000a; }
    h1 { text-align: center; color: #ff6f61; margin-bottom: 24px;}
    .section { margin-bottom: 30px; background: #292944; border-radius:12px; box-shadow: 0 5px 15px #0009; padding: 18px 16px;}
    label { font-weight: bold; margin-right: 6px; }
    input, button { border-radius: 7px; font-size: 1rem; }
    input[type="text"], input[type="date"] { width:98%; padding:9px 12px; border: none; margin-bottom: 8px;}
    input[type="file"]::-webkit-file-upload-button { cursor:pointer; }
    input[type="file"] { background:#eee; color:#222; padding: 7px;}
    button { background:#ff6f61; color:#fff; border:none; font-weight: bold; padding: 10px 0; width:100%; margin-top:12px; cursor:pointer;}
    button:disabled { background: #a94c43; }
    .success { background: #39e2a0ee; color: #062; padding:12px; margin-top:9px; border-radius:8px;}
    .error   { background: #fb5858dd; color: #391313; padding:12px; margin-top:9px; border-radius:8px;}
    #walletAddress { text-align:center; color:#ffe7ba; margin-bottom:20px;}
    #qr-reader { margin: 20px 0 8px 0; border-radius: 12px; overflow: hidden; box-shadow: 0 6px 20px #0009;}
    .flash-toggle { background:#ffa17f; color:#444; text-align:center; margin:14px auto 0 auto; border-radius:100px; font-weight:700; padding:8px 0; width:70%; cursor:pointer; }
    img.prod-image { max-width: 180px; border-radius:9px; margin:8px 0 10px 0; border:2px solid #fff3; box-shadow:0 4px 12px #111a;}
    #start-camera-btn { background:#3a3a5f; color:#eee; border:none; border-radius:8px; padding: 10px; margin-bottom: 12px; cursor:pointer; width:100%; font-weight:bold; }
    #start-camera-btn:disabled { background:#555577; cursor: not-allowed; }
    @media(max-width:625px){ .container {padding:12px;} }
  </style>
</head>
<body>
<div class="container" role="main">
  <h1>Fake Product Identification</h1>
  <button id="connectWalletBtn" aria-label="Connect Ethereum Wallet">ðŸ”— Connect Wallet</button>
  <div id="walletAddress" aria-live="polite"></div>

  <section class="section" aria-labelledby="register-title">
    <h2 id="register-title">Register New Product</h2>
    <form id="registration-form" novalidate>
      <label for="reg-productId">Product ID</label>
      <input type="text" id="reg-productId" name="productId" required aria-required="true" />
      <label for="reg-name">Product Name</label>
      <input type="text" id="reg-name" name="name" required aria-required="true" />
      <label for="reg-manufacturer">Manufacturer</label>
      <input type="text" id="reg-manufacturer" name="manufacturer" required aria-required="true" />
      <label for="reg-manufactureDate">Manufacture Date</label>
      <input type="date" id="reg-manufactureDate" name="manufactureDate" required aria-required="true" />
      <label for="reg-photo">Photo When Packed</label>
      <input type="file" accept="image/*" id="reg-photo" required aria-required="true" />
      <button type="submit" id="register-btn">Register Product</button>
    </form>
    <div id="registration-result" role="alert" aria-live="polite"></div>
  </section>

  <section class="section" aria-labelledby="verify-title">
    <h2 id="verify-title">Verify Product</h2>

    <label for="verify-productId">Product ID (scan from phone body or enter)</label>
    <input type="text" id="verify-productId" placeholder="Scan or enter product ID" aria-label="Product ID input" autocomplete="off"/>
    <button id="verify-btn" disabled>Verify Product</button>

    <button id="start-camera-btn" aria-label="Start camera to scan QR code">Start Camera</button>
    <div id="qr-reader" aria-label="QR Code Camera Scanner"></div>
    <div class="flash-toggle" id="flash-toggle" tabindex="0" aria-pressed="false" style="display:none" role="button" aria-label="Toggle Flashlight">ðŸ”¦ Toggle Flashlight</div>

    <div id="qr-result" aria-live="polite"></div>

    <div id="verification-result" role="alert" aria-live="polite"></div>

    <div id="user-report-section" style="display:none;margin-top:15px;">
      <label for="user-report">Describe any issues:</label>
      <input type="text" id="user-report" placeholder="e.g. wrong model, damaged, box opened" aria-label="User issue description"/>
      <button id="report-btn">Report to Flipkart</button>
      <div id="report-result" role="alert" aria-live="polite"></div>
    </div>

    <button id="save-proof-btn" style="display:none;margin-top:10px;">Download Verification Proof</button>
  </section>
</div>

<script>
/* ==== SETTINGS - Replace these ==== */
// Your contract ABI here (must support registerProduct and verifyProduct with imageHash, and optional logReport)
const contractABI = [ 
  {
    "inputs": [
      {"internalType": "string", "name": "productId", "type": "string"},
      {"internalType": "string", "name": "name", "type": "string"},
      {"internalType": "string", "name": "manufacturer", "type": "string"},
      {"internalType": "uint256", "name": "manuDate", "type": "uint256"},
      {"internalType": "string", "name": "imageHash", "type": "string"}
    ],
    "name": "registerProduct",
    "outputs": [],
    "stateMutability": "nonpayable", "type": "function"
  },
  {
    "inputs": [{"internalType": "string", "name": "productId", "type": "string"}],
    "name": "verifyProduct",
    "outputs": [
      {"internalType": "bool", "name": "exists", "type": "bool"},
      {"internalType": "string", "name": "name", "type": "string"},
      {"internalType": "string", "name": "manufacturer", "type": "string"},
      {"internalType": "string", "name": "imageHash", "type": "string"}
    ],
    "stateMutability": "view", "type": "function"
  },
  {
    "inputs": [
      {"internalType": "string", "name": "productId", "type": "string"},
      {"internalType": "string", "name": "remarks", "type": "string"}
    ],
    "name": "logReport",
    "outputs": [],
    "stateMutability": "nonpayable", "type": "function"
  }
];

// Contract deployed address
const contractAddress = "0x0fC5025C764cE34df352757e82f7B5c4Df39A836"; // <<< UPDATE THIS
// nft.storage API key - get a free key from https://nft.storage/
const NFT_STORAGE_TOKEN = "YOUR_NFT_STORAGE_API_KEY"; // <<< UPDATE THIS

/* ==== VARIABLES & ELEMENTS ==== */
let web3, contract, currentAccount;
let scanner, currentCameraId, flashOn = false;

const connectWalletBtn = document.getElementById("connectWalletBtn");
const walletAddressDiv = document.getElementById("walletAddress");
const registerForm = document.getElementById("registration-form");
const registrationResult = document.getElementById("registration-result");
const verifyBtn = document.getElementById("verify-btn");
const verifyProductIdInput = document.getElementById("verify-productId");
const verificationResult = document.getElementById("verification-result");
const userReportSection = document.getElementById("user-report-section");
const userReportInput = document.getElementById("user-report");
const reportBtn = document.getElementById("report-btn");
const reportResult = document.getElementById("report-result");
const saveProofBtn = document.getElementById("save-proof-btn");
const qrReaderDiv = document.getElementById("qr-reader");
const qrResultDiv = document.getElementById("qr-result");
const flashToggleBtn = document.getElementById("flash-toggle");
const startCameraBtn = document.getElementById("start-camera-btn");

/* ==== CONNECT WALLET ==== */
connectWalletBtn.onclick = async () => {
  if (window.ethereum) {
    try {
      web3 = new Web3(window.ethereum);
      const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
      currentAccount = accounts[0];
      contract = new web3.eth.Contract(contractABI, contractAddress);
      walletAddressDiv.textContent = "Connected: " + currentAccount;
      verifyBtn.disabled = false;
    } catch (error) {
      alert("Wallet connection denied.");
    }
  } else {
    alert("Please install MetaMask to use this app.");
  }
};

/* ==== REGISTER PRODUCT - Upload photo to IPFS and register on chain ==== */
registerForm.onsubmit = async (e) => {
  e.preventDefault();
  registrationResult.textContent = "";
  registrationResult.className = "";

  const productId = document.getElementById('reg-productId').value.trim();
  const name = document.getElementById('reg-name').value.trim();
  const manufacturer = document.getElementById('reg-manufacturer').value.trim();
  const date = document.getElementById('reg-manufactureDate').value;
  const photoFile = document.getElementById('reg-photo').files[0];

  if (!productId || !name || !manufacturer || !date) {
    registrationResult.textContent = "âŒ Please fill all fields.";
    registrationResult.className = "error";
    return;
  }
  if (!photoFile) {
    registrationResult.textContent = "âŒ Please upload the product photo!";
    registrationResult.className = "error";
    return;
  }

  try {
    const client = new NFTStorage.NFTStorage({ token: NFT_STORAGE_TOKEN });
    const ipfsHash = await client.storeBlob(photoFile); // Returns IPFS hash string
    const timestamp = Math.floor(new Date(date).getTime() / 1000);

    await contract.methods.registerProduct(productId, name, manufacturer, timestamp, ipfsHash)
      .send({ from: currentAccount });

    registrationResult.textContent = "âœ… Product Registered!";
    registrationResult.className = "success";
    registerForm.reset();
  } catch (err) {
    console.error(err);
    registrationResult.textContent = "âŒ Error registering product or uploading photo.";
    registrationResult.className = "error";
  }
};

/* ==== VERIFY PRODUCT ==== */
verifyBtn.onclick = async () => {
  verificationResult.textContent = "";
  verificationResult.className = "";
  saveProofBtn.style.display = "none";
  userReportSection.style.display = "none";
  reportResult.textContent = "";
  reportResult.className = "";

  const pid = verifyProductIdInput.value.trim();
  if (!pid) {
    verificationResult.textContent = "âŒ Please enter or scan a product ID.";
    verificationResult.className = "error";
    return;
  }

  try {
    const res = await contract.methods.verifyProduct(pid).call({ from: currentAccount });
    // res => [exists, name, manufacturer, imageHash]
    if (res[0]) {
      verificationResult.innerHTML = `
        âœ… <strong>Valid Product</strong><br>
        <strong>Name:</strong> ${res[1]}<br>
        <strong>Manufacturer:</strong> ${res[2]}<br>
        ${res[3] ? <img class="prod-image" src="<https://ipfs.io/ipfs/${res>[3]}" alt="Packed Product Photo"/> : ""}
        <p style="color:#ffe089;">Check this image and details: Does this match your delivered product and packing?</p>
      `;
      verificationResult.className = "success";
      // Show reporting UI and save proof button
      userReportSection.style.display = "block";
      saveProofBtn.style.display = "inline-block";
    } else {
      verificationResult.textContent = "âŒ Product not found! Please refuse delivery or scan from your phone's body QR/serial.";
      verificationResult.className = "error";
    }
  } catch (e) {
    console.error(e);
    verificationResult.textContent = "âŒ Error verifying product.";
    verificationResult.className = "error";
  }
};

/* ==== USER REPORT ==== */
reportBtn.onclick = async () => {
  reportResult.textContent = "";
  reportResult.className = "";

  const productId = verifyProductIdInput.value.trim();
  const remarks = userReportInput.value.trim();

  if (!remarks) {
    reportResult.textContent = "âŒ Please describe the issue!";
    return;
  }

  try {
    await contract.methods.logReport(productId, remarks).send({ from: currentAccount });
    reportResult.textContent = "âœ… Issue reported! Support will contact you if necessary.";
    reportResult.className = "success";
    userReportInput.value = "";
  } catch (err) {
    console.error(err);
    reportResult.textContent = "âŒ Failed to submit report. Please try again.";
    reportResult.className = "error";
  }
};

/* ==== DOWNLOAD VERIFICATION PROOF ==== */
saveProofBtn.onclick = () => {
  const productId = verifyProductIdInput.value.trim();
  const verifiedText = verificationResult.innerText || verificationResult.textContent || "";
  const time = new Date().toLocaleString();
  const content = Verification Proof\nProduct ID: ${productId}\n\n${verifiedText}\n\nChecked at: ${time};
  const blob = new Blob([content], { type: "text/plain" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = verification-proof-${productId}.txt;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
};

/* ==== CAMERA & QR SCANNING ==== */
startCameraBtn.onclick = async () => {
  if (!scanner) {
    scanner = new Html5Qrcode("qr-reader");
  }
  startCameraBtn.disabled = true;
  qrResultDiv.textContent = "";
  try {
    const devices = await Html5Qrcode.getCameras();
    if (!devices || devices.length === 0) {
      qrResultDiv.textContent = "âŒ No cameras found on this device.";
      startCameraBtn.disabled = false;
      return;
    }
    // Pick the back camera if available, else first camera
    const backCam = devices.find(cam => cam.label.toLowerCase().includes("back")) || devices[0];
    currentCameraId = backCam.id;

    await scanner.start(
      { deviceId: { exact: currentCameraId } },
      { fps: 10, qrbox: 250 },
      (decodedText) => {
        verifyProductIdInput.value = decodedText;
        qrResultDiv.textContent = "ðŸ“¦ QR Scanned: " + decodedText;
        verifyBtn.click();
      },
      (errorMessage) => {
        // console.log("QR scan error:", errorMessage);
      }
    );

    // Show flash toggle if supported
    const capabilities = await scanner.getRunningTrackCapabilities?.();
    if (capabilities && capabilities.torch) {
      flashToggleBtn.style.display = "block";
    } else {
      flashToggleBtn.style.display = "none";
    }
  } catch (err) {
    console.error(err);
    qrResultDiv.textContent = "âŒ Unable to start camera: " + err.message;
    startCameraBtn.disabled = false;
  }
};

/* ==== FLASHLIGHT TOGGLE ==== */
flashToggleBtn.onclick = async () => {
  if (!scanner || !currentCameraId) return;
  flashOn = !flashOn;
  try {
    await scanner.applyVideoConstraints({ advanced: [{ torch: flashOn }] });
    flashToggleBtn.setAttribute("aria-pressed", flashOn);
  } catch (err) {
    alert("Flashlight not supported on this device.");
  }
};

/* ==== On page load ==== */
window.onload = () => {
  verifyBtn.disabled = true;
  flashToggleBtn.style.display = "none";
  qrResultDiv.textContent = "";
};
</script>
</body>
</html>
