<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Product Registry DApp</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(to right, #141e30, #243b55);
      color: #fff;
      text-align: center;
      padding: 30px;
    }
    h1 {
      color: #00ffff;
    }
    input, button {
      padding: 10px;
      margin: 5px;
      width: 250px;
    }
    #qr-reader {
      width: 300px;
      margin: auto;
    }
    #status {
      margin-top: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <h1>🔒 Product Registry DApp</h1>

  <button onclick="connectWallet()">🔗 Connect Wallet</button><br><br>

  <div id="qr-reader"></div><br>

  <form id="productForm">
    <input type="text" id="productId" placeholder="Product ID (barcode)" required><br>
    <input type="text" id="name" placeholder="Product Name" required><br>
    <input type="text" id="manufacturer" placeholder="Manufacturer" required><br>
    <input type="date" id="mDate" required><br>
    <button type="submit">✅ Register Product</button>
  </form>

  <br><br>

  <input type="text" id="verifyProductId" placeholder="Enter Product ID to Verify">
  <button onclick="verifyProduct()">🔍 Verify</button>

  <p id="status"></p>

  <script>
    let web3;
    let contract;

    const contractAddress = "0xddaAd340b0f1Ef65169Ae5E41A8b10776a75482d";
    const contractABI = [ /* paste your ABI here */ 
      {
        "anonymous": false,
        "inputs": [
          { "indexed": false, "internalType": "string", "name": "productId", "type": "string" },
          { "indexed": false, "internalType": "string", "name": "name", "type": "string" },
          { "indexed": false, "internalType": "string", "name": "manufacturer", "type": "string" }
        ],
        "name": "ProductRegistered",
        "type": "event"
      },
      {
        "inputs": [
          { "internalType": "string", "name": "productId", "type": "string" },
          { "internalType": "string", "name": "name", "type": "string" },
          { "internalType": "string", "name": "manufacturer", "type": "string" },
          { "internalType": "uint256", "name": "mDate", "type": "uint256" }
        ],
        "name": "registerProduct",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "string", "name": "productId", "type": "string" }
        ],
        "name": "verifyProduct",
        "outputs": [
          { "internalType": "bool", "name": "exists", "type": "bool" },
          { "internalType": "string", "name": "name", "type": "string" },
          { "internalType": "string", "name": "manufacturer", "type": "string" }
        ],
        "stateMutability": "view",
        "type": "function"
      }
    ];

    async function connectWallet() {
      if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        await ethereum.request({ method: "eth_requestAccounts" });
        contract = new web3.eth.Contract(contractABI, contractAddress);
        document.getElementById("status").innerText = "✅ Wallet connected!";
      } else {
        alert("Please install MetaMask.");
      }
    }

    document.getElementById("productForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      const accounts = await web3.eth.getAccounts();
      const productId = document.getElementById("productId").value;
      const name = document.getElementById("name").value;
      const manufacturer = document.getElementById("manufacturer").value;
      const mDate = new Date(document.getElementById("mDate").value).getTime();

      try {
        await contract.methods.registerProduct(productId, name, manufacturer, mDate)
          .send({ from: accounts[0] });

        document.getElementById("status").innerText = "✅ Product registered successfully!";
      } catch (error) {
        document.getElementById("status").innerText = "❌ Error: " + error.message;
      }
    });

    async function verifyProduct() {
      const productId = document.getElementById("verifyProductId").value;

      try {
        const result = await contract.methods.verifyProduct(productId).call();
        if (result.exists) {
          document.getElementById("status").innerText =
            `✅ Product Found:\nName: ${result.name}\nManufacturer: ${result.manufacturer}`;
        } else {
          document.getElementById("status").innerText = "❌ Product not found.";
        }
      } catch (error) {
        document.getElementById("status").innerText = "❌ Error: " + error.message;
      }
    }

    // Barcode Scanner with back camera
    const html5QrCode = new Html5Qrcode("qr-reader");
    Html5Qrcode.getCameras().then(devices => {
      const backCamera = devices.find(device => device.label.toLowerCase().includes('back')) || devices[0];
      html5QrCode.start(
        backCamera.id,
        { fps: 10, qrbox: 250 },
        (decodedText) => {
          document.getElementById("productId").value = decodedText;
        },
        (errorMessage) => {}
      );
    }).catch(err => {
      document.getElementById("status").innerText = "❌ Camera error: " + err;
    });
  </script>

</body>
</html>
