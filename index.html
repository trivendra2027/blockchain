<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QR Product Registry & Verification</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.7.4/dist/web3.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: Arial; padding: 20px; background: #f4f4f4; }
    h1 { color: #333; }
    form, .section { margin-bottom: 20px; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    input, button, select, label { display: block; margin: 10px 0; padding: 8px; width: 100%; max-width: 500px; }
    #qr-reader { width: 300px; margin-top: 10px; }
    .success { color: green; font-weight: bold; }
    .error { color: red; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Product Registry & Verification</h1>

  <div class="section">
    <h2>Scan Product QR Code</h2>
    <div id="qr-reader"></div>
    <button onclick="startScanner()">Start Scanning</button>
    <div id="qr-result"></div>
    <div id="flash-toggle" style="display:none;">
      <button onclick="toggleFlashlight()">Toggle Flash</button>
    </div>
  </div>

  <div class="section">
    <h2>Register Product</h2>
    <form id="registration-form">
      <label for="reg-productId">Product ID (from QR)</label>
      <input type="text" id="reg-productId" required />

      <label for="reg-name">Product Name</label>
      <input type="text" id="reg-name" required />

      <label for="reg-manufacturer">Manufacturer</label>
      <input type="text" id="reg-manufacturer" required />

      <label for="reg-manufactureDate">Manufacture Date</label>
      <input type="date" id="reg-manufactureDate" required />

      <label for="reg-file">Product File (image/pdf)</label>
      <input type="file" id="reg-file" accept=".png,.jpg,.jpeg,.pdf" />

      <button type="submit">Register</button>
    </form>
    <div id="registration-result"></div>
  </div>

  <div class="section">
    <h2>Verify Product</h2>
    <form id="verification-form">
      <label for="verify-productId">Product ID</label>
      <input type="text" id="verify-productId" required />
      <button type="submit">Verify</button>
    </form>
    <div id="verification-result"></div>
  </div>

  <script>
    let web3, contract, userAccount;
    const contractAddress = "0xddaAd340b0f1Ef65169Ae5E41A8b10776a75482d";
    const abi = [
      {
        "inputs": [
          { "internalType": "string", "name": "productId", "type": "string" },
          { "internalType": "string", "name": "name", "type": "string" },
          { "internalType": "string", "name": "manufacturer", "type": "string" },
          { "internalType": "uint256", "name": "manufactureDate", "type": "uint256" }
        ],
        "name": "registerProduct",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [{ "internalType": "string", "name": "productId", "type": "string" }],
        "name": "verifyProduct",
        "outputs": [
          { "internalType": "bool", "name": "", "type": "bool" },
          { "internalType": "string", "name": "", "type": "string" },
          { "internalType": "string", "name": "", "type": "string" }
        ],
        "stateMutability": "view",
        "type": "function"
      }
    ];

    window.addEventListener("load", async () => {
      if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        await window.ethereum.request({ method: "eth_requestAccounts" });
        const accounts = await web3.eth.getAccounts();
        userAccount = accounts[0];
        contract = new web3.eth.Contract(abi, contractAddress);
      } else {
        alert("MetaMask not detected!");
      }
    });

    document.getElementById("registration-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const productId = document.getElementById("reg-productId").value;
      const name = document.getElementById("reg-name").value;
      const manufacturer = document.getElementById("reg-manufacturer").value;
      const date = document.getElementById("reg-manufactureDate").value;
      const fileInput = document.getElementById("reg-file");
      const timestamp = Math.floor(new Date(date).getTime() / 1000);
      const resultDiv = document.getElementById("registration-result");

      resultDiv.textContent = "";

      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const base64File = await toBase64(file);
        console.log("File data:", base64File);
      }

      try {
        await contract.methods.registerProduct(productId, name, manufacturer, timestamp).send({ from: userAccount });
        resultDiv.textContent = "‚úÖ Product Registered!";
        resultDiv.className = "success";
        e.target.reset();
      } catch (err) {
        console.error(err);
        resultDiv.textContent = "‚ùå Registration failed.";
        resultDiv.className = "error";
      }
    });

    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
      });
    }

    document.getElementById("verification-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const productId = document.getElementById("verify-productId").value;
      const resultDiv = document.getElementById("verification-result");
      try {
        const res = await contract.methods.verifyProduct(productId).call();
        if (res[0]) {
          resultDiv.innerHTML = `‚úÖ <strong>Valid Product</strong><br><strong>Name:</strong> ${res[1]}<br><strong>Manufacturer:</strong> ${res[2]}`;
          resultDiv.className = "success";
        } else {
          resultDiv.innerHTML = `‚ùå <strong>Fake or Unregistered Product!</strong>`;
          resultDiv.className = "error";
        }
      } catch (err) {
        resultDiv.textContent = "‚ùå Verification failed.";
        resultDiv.className = "error";
      }
    });

    let scanner;
    let currentCameraId;

    async function startScanner() {
      scanner = new Html5Qrcode("qr-reader");
      try {
        const devices = await Html5Qrcode.getCameras();
        if (devices && devices.length) {
          const backCam = devices.find(c => c.label.toLowerCase().includes("back")) || devices[0];
          currentCameraId = backCam.id;
          await scanner.start(
            { deviceId: { exact: currentCameraId } },
            { fps: 10, qrbox: 250 },
            async (decodedText) => {
              document.getElementById("verify-productId").value = decodedText;
              document.getElementById("reg-productId").value = decodedText;
              document.getElementById("qr-result").innerHTML = `üì¶ QR Detected: <strong>${decodedText}</strong>`;

              try {
                const res = await contract.methods.verifyProduct(decodedText).call({ from: userAccount });
                const resultDiv = document.getElementById("verification-result");
                if (res[0]) {
                  resultDiv.innerHTML = `‚úÖ <strong>Valid Product</strong><br><strong>Name:</strong> ${res[1]}<br><strong>Manufacturer:</strong> ${res[2]}`;
                  resultDiv.className = "success";
                } else {
                  resultDiv.innerHTML = `‚ùå <strong>Fake or Unregistered Product!</strong>`;
                  resultDiv.className = "error";
                }
              } catch (err) {
                document.getElementById("verification-result").textContent = "‚ùå Scan Verification Error";
                document.getElementById("verification-result").className = "error";
              }
            },
            (error) => console.warn(error)
          );

          const capabilities = await scanner.getRunningTrackCapabilities();
          if (capabilities.torch) {
            document.getElementById("flash-toggle").style.display = "block";
          }
        }
      } catch (err) {
        document.getElementById("qr-result").innerText = "‚ùå Unable to access camera.";
      }
    }

    function toggleFlashlight() {
      if (scanner && currentCameraId) {
        scanner.applyVideoConstraints({ advanced: [{ torch: true }] });
      }
    }
  </script>
</body>
</html>
