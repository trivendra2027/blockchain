<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Anti-Fake Product System - QR Sealed with Photos</title>
<script src="https://cdn.jsdelivr.net/npm/web3@1.7.4/dist/web3.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://unpkg.com/nft.storage/dist/bundle.js"></script>
<style>
body { background:#22263c; color:#eee; font-family:Montserrat,Arial,sans-serif; }
.container { max-width:660px; margin:34px auto; border-radius:16px; background:#191e32; padding:36px 26px; box-shadow:0 8px 38px #000a; }
h1 {text-align:center; color:#24e1ae;}
.section { background: #232c49; margin-bottom:38px; border-radius:10px; box-shadow:0 3px 14px #0007; padding:19px 17px;}
input,button { border-radius:8px; font-size:1rem;}
button { background:#24e1ae; color:#151827; font-weight:700; width:100%; margin-top:11px; border:none; padding:12px; }
button:disabled{background:#52736b;}
label{font-weight:600;}
.success{background:#84f4c7; color:#085; padding:11px; border-radius:9px;}
.error{background:#f97d7d; color:#411313; padding:11px; border-radius:9px;}
img.prod-image,img.deliver-image{max-width:185px; border-radius:8px; border:2px solid #fff3; box-shadow:0 3px 10px #0008;}
#qr-reader{margin:15px 0; border-radius:9px; box-shadow:0 5px 18px #0009;}
@media (max-width:660px){ .container{padding:12px;} }
</style>
</head>
<body>
<div class="container">
<h1>Anti-Fake Product Proof System</h1>
<button id="connectWalletBtn">Connect Wallet</button>
<div id="walletAddress"></div>
<!-- Registration Section -->
<section class="section">
  <h2>Packing: Register with QR and Seal</h2>
  <input id="reg-sealQR" type="text" placeholder="Enter/scan Seal QR ID"/>
  <input id="reg-name" type="text" placeholder="Product Name"/>
  <input id="reg-manufacturer" type="text" placeholder="Manufacturer"/>
  <input id="reg-date" type="date"/>
  <label>Photo of Factory-Sealed Pack</label>
  <input id="reg-photo" type="file" accept="image/*"/>
  <button id="reg-btn">Register (On Chain)</button>
  <div id="reg-status"></div>
</section>
<!-- Delivery Section -->
<section class="section">
  <h2>Delivery: Scan QR & Upload Delivery Photo</h2>
  <input id="deliv-sealQR" type="text" placeholder="Scan/enter Seal QR"/>
  <button id="start-delivqr-btn">Scan QR Now</button>
  <div id="qr-reader"></div>
  <label>Camera Delivery Photo</label>
  <input id="deliv-photo" type="file" accept="image/*"/>
  <button id="deliv-btn">Mark as Delivered (open seal)</button>
  <div id="deliv-status"></div>
</section>
<!-- Verification Section -->
<section class="section">
  <h2>Customer/Support Verify All Proofs</h2>
  <input id="verif-sealQR" type="text" placeholder="Enter Seal QR"/>
  <button id="verif-btn">Check Package</button>
  <div id="verif-result"></div>
</section>
</div>
<script>
// -----contract settings
const contractABI = [
  {"inputs":[{"internalType":"string","name":"packageQR","type":"string"},{"internalType":"string","name":"name","type":"string"},{"internalType":"string","name":"manufacturer","type":"string"},{"internalType":"uint256","name":"manufactureDate","type":"uint256"},{"internalType":"string","name":"packedPhoto","type":"string"}],"name":"registerProduct","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"string","name":"packageQR","type":"string"},{"internalType":"string","name":"deliveryPhoto","type":"string"}],"name":"openSeal","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"string","name":"packageQR","type":"string"}],"name":"verifySeal","outputs":[{"internalType":"bool","name":"exists","type":"bool"},{"internalType":"string","name":"name","type":"string"},{"internalType":"string","name":"manufacturer","type":"string"},{"internalType":"uint256","name":"manufactureDate","type":"uint256"},{"internalType":"bool","name":"sealOpened","type":"bool"},{"internalType":"string","name":"packedPhoto","type":"string"},{"internalType":"string","name":"deliveryPhoto","type":"string"}],"stateMutability":"view","type":"function"}
];
const contractAddress = "0xYourContractAddressHere"; // Set yours!
const NFT_STORAGE_TOKEN = "YOUR_NFT_STORAGE_API_KEY"; // Set yours!
// -----
let web3, contract, account, qrScanner;
const connectWalletBtn = document.getElementById("connectWalletBtn");
const walletAddressDiv = document.getElementById("walletAddress");

// Connect wallet
connectWalletBtn.onclick = async () => {
  if(window.ethereum){
    web3 = new Web3(window.ethereum);
    const accounts = await window.ethereum.request({method:"eth_requestAccounts"});
    account = accounts[0];
    contract = new web3.eth.Contract(contractABI, contractAddress);
    walletAddressDiv.textContent = "Connected: "+account;
  }else alert("Install MetaMask.");
};

// Register product and seal
document.getElementById("reg-btn").onclick = async ()=>{
  const sealQR=document.getElementById("reg-sealQR").value.trim();
  const name=document.getElementById("reg-name").value.trim();
  const man=document.getElementById("reg-manufacturer").value.trim();
  const date=document.getElementById("reg-date").value;
  const photo=document.getElementById("reg-photo").files[0];
  const status=document.getElementById("reg-status");
  if(!sealQR||!name||!man||!date||!photo){status.textContent="All fields required";status.className="error";return;}
  if(!web3||!account){status.textContent="Connect wallet";status.className="error";return;}
  try{
    const client=new NFTStorage.NFTStorage({token:NFT_STORAGE_TOKEN});
    const hash=await client.storeBlob(photo);
    const timestamp=Math.floor(new Date(date).getTime()/1000);
    await contract.methods.registerProduct(sealQR,name,man,timestamp,hash).send({from:account});
    status.textContent="✅ Product Registered & Seal Set!";status.className="success";
    document.getElementById("reg-photo").value="";
  }catch(e){
    status.textContent="Error: "+e.message;status.className="error";
  }
};

// Delivery: Scan seal and upload photo, open seal on-chain
document.getElementById("deliv-btn").onclick = async ()=>{
  const sealQR=document.getElementById("deliv-sealQR").value.trim();
  const photo=document.getElementById("deliv-photo").files[0];
  const status=document.getElementById("deliv-status");
  if(!sealQR||!photo){status.textContent="Scan QR and take delivery photo";status.className="error";return;}
  if(!web3||!account){status.textContent="Connect wallet";status.className="error";return;}
  try{
    const client=new NFTStorage.NFTStorage({token:NFT_STORAGE_TOKEN});
    const hash=await client.storeBlob(photo);
    await contract.methods.openSeal(sealQR,hash).send({from:account});
    status.textContent="✅ Seal marked opened & delivery proof uploaded!";status.className="success";
    document.getElementById("deliv-photo").value="";
  }catch(e){
    status.textContent="Error: "+e.message;status.className="error";
  }
};

// Start QR scanner for seal scan (delivered)
document.getElementById("start-delivqr-btn").onclick = async ()=>{
  if(!qrScanner)qrScanner = new Html5Qrcode("qr-reader");
  qrScanner.start({facingMode:"environment"},{fps:12,qrbox:220},txt=>{
    document.getElementById("deliv-sealQR").value=txt;
    qrScanner.stop();
    document.getElementById("qr-reader").innerHTML="✔ QR: "+txt;
  });
};

// Verification for customer/support
document.getElementById("verif-btn").onclick = async ()=>{
  const sealQR=document.getElementById("verif-sealQR").value.trim();
  const out=document.getElementById("verif-result");
  if(!sealQR){out.textContent="Enter Seal QR";return;}
  if(!web3||!account){out.textContent="Connect wallet first";return;}
  try{
    const res=await contract.methods.verifySeal(sealQR).call();
    if(!res.exists){out.textContent="Code not found";return;}
    let html=`<b>Name:</b> ${res.name}<br/><b>Manufacturer:</b>${res.manufacturer}<br/>
    <b>Manuf.Date:</b>${new Date(res.manufactureDate*1000).toLocaleDateString()}<br/>
    <b>Seal state:</b> ${res.sealOpened ? "<span style='color:#c00;'>❌ Seal was broken</span>":"<span style='color:#0c4;'>✅ Seal intact at pack</span>"}<br/>`;
    if(res.packedPhoto)html+=<b>Packed photo:</b><br><img class="prod-image" src="https://ipfs.io/ipfs/${res.packedPhoto}" alt="Packed Photo"/>;
    if(res.deliveryPhoto&&res.sealOpened)html+=<br><b>Delivery photo:</b><br><img class="deliver-image" src="https://ipfs.io/ipfs/${res.deliveryPhoto}" alt="Delivered Photo"/>;
    html+=<p>Compare photos and QR. If the seal is broken before delivery, or items differ, raise a dispute!</p>;
    out.innerHTML=html;
  }catch(e){
    out.textContent="Error: "+e.message;
  }
};
</script>
</body>
</html>
