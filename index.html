<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Anti-Fake Product Proof</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #1b1f3a;
      color: #fff;
      padding: 1rem;
      margin: 0;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: #2a2f4a;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    h1 {
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .section {
      margin-bottom: 2rem;
      background: #353b5a;
      padding: 1rem;
      border-radius: 8px;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input[type="text"], input[type="file"], input[type="date"] {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border-radius: 4px;
      border: none;
      font-size: 1rem;
    }
    button {
      padding: 10px 16px;
      font-size: 1rem;
      margin-top: 10px;
      cursor: pointer;
      border-radius: 6px;
      border: none;
      background-color: #4caf50;
      color: white;
    }
    .prod-photo {
      width: 120px;
      height: auto;
      border: 1px solid #aaa;
      margin: 5px;
    }
    .compare-box {
      display: flex;
      gap: 20px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>üõ°Ô∏è Anti-Fake Product Proof System</h1>
  <button id="connectWalletBtn">üîó Connect Wallet</button>
  <div id="walletAddress"></div>

  <section class="section">
    <h2>üì¶ Packing: Register with QR and Seal</h2>
    <label for="reg-sealQR">Seal QR Code</label>
    <input id="reg-sealQR" type="text" placeholder="Enter or scan Seal QR code">

    <label for="reg-name">Product Name</label>
    <input id="reg-name" type="text" placeholder="e.g. Smartwatch XYZ">

    <label for="reg-manufacturer">Manufacturer</label>
    <input id="reg-manufacturer" type="text" placeholder="e.g. Tech Corp Ltd.">

    <label for="reg-date">Manufacture Date</label>
    <input id="reg-date" type="date">

    <label for="reg-photo">Photo of Factory-Sealed Pack</label>
    <input id="reg-photo" type="file" accept="image/*">

    <button id="reg-btn">‚úÖ Register (On Chain)</button>
    <div id="reg-status"></div>
  </section>

  <section class="section">
    <h2>üöö Delivery: Seal Scan + Delivery Photo</h2>
    <label for="deliv-sealQR">Scan or Enter Seal QR Code</label>
    <input id="deliv-sealQR" type="text" placeholder="Scan or type Seal QR">
    <button id="start-delivqr-btn">üì∑ Start QR Scan</button>
    <div id="qr-reader"></div>

    <label for="deliv-photo">Delivery Photo (camera)</label>
    <input id="deliv-photo" type="file" accept="image/*">

    <button id="deliv-btn">üì¨ Mark as Delivered (Open Seal)</button>
    <div id="deliv-status"></div>
  </section>

  <section class="section">
    <h2>üîç Customer/Support: Verify Product</h2>
    <label for="verif-sealQR">Enter Seal QR Code</label>
    <input id="verif-sealQR" type="text" placeholder="Type the Seal QR to verify">
    <button id="verif-btn">üîé Check Package Info</button>
    <div id="verif-result"></div>
  </section>
</div>

<script>
  const contractAddress = "0xYourContractAddressHere";
  const contractABI = [...] // Add your ABI here
  const NFT_STORAGE_TOKEN = "YOUR_NFT_STORAGE_API_KEY";
  let web3, contract, userAccount;

  document.getElementById("connectWalletBtn").onclick = async () => {
    if (window.ethereum) {
      await window.ethereum.request({ method: "eth_requestAccounts" });
      web3 = new Web3(window.ethereum);
      const accounts = await web3.eth.getAccounts();
      userAccount = accounts[0];
      document.getElementById("walletAddress").textContent = "Connected: " + userAccount;
      contract = new web3.eth.Contract(contractABI, contractAddress);
    } else {
      alert("Please install MetaMask!");
    }
  };

  async function uploadToIPFS(file) {
    const formData = new FormData();
    formData.append("file", file);
    const res = await fetch("https://api.nft.storage/upload", {
      method: "POST",
      headers: { Authorization: `Bearer ${NFT_STORAGE_TOKEN}` },
      body: formData
    });
    const data = await res.json();
    return data.value.cid;
  }

  document.getElementById("reg-btn").onclick = async () => {
    const qr = document.getElementById("reg-sealQR").value;
    const name = document.getElementById("reg-name").value;
    const manu = document.getElementById("reg-manufacturer").value;
    const date = document.getElementById("reg-date").value;
    const file = document.getElementById("reg-photo").files[0];

    const cid = await uploadToIPFS(file);
    await contract.methods.register(qr, name, manu, date, cid).send({ from: userAccount });
    document.getElementById("reg-status").innerText = "‚úÖ Registered!";
  };

  document.getElementById("deliv-btn").onclick = async () => {
    const qr = document.getElementById("deliv-sealQR").value;
    const file = document.getElementById("deliv-photo").files[0];
    const cid = await uploadToIPFS(file);
    await contract.methods.deliver(qr, cid).send({ from: userAccount });
    document.getElementById("deliv-status").innerText = "üì¨ Delivery updated!";
  };

  document.getElementById("verif-btn").onclick = async () => {
    const qr = document.getElementById("verif-sealQR").value;
    const res = await contract.methods.getProduct(qr).call();
    const out = document.getElementById("verif-result");
    let html = `<b>Product:</b> ${res.name} <br><b>Manufacturer:</b> ${res.manufacturer} <br><b>Date:</b> ${res.manufactureDate}<br>`;
    html += `<div class="compare-box">`;
    html += `<div><b>Packed</b><br><img class="prod-photo" src="https://ipfs.io/ipfs/${res.packedPhoto}" alt="Packed Photo"/></div>`;
    html += `<div><b>Delivered</b><br><img class="prod-photo" src="https://ipfs.io/ipfs/${res.deliveredPhoto}" alt="Delivered Photo"/></div>`;
    html += `</div>`;
    out.innerHTML = html;
  };

  document.getElementById("start-delivqr-btn").onclick = async () => {
    const qrScanner = new Html5Qrcode("qr-reader");
    await qrScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, qr => {
      document.getElementById("deliv-sealQR").value = qr;
      document.getElementById("qr-reader").innerHTML = `<span style="color:#82ffa2;">Scanned:</span> ${qr}`;
      qrScanner.stop();
    });
  };
</script>
</body>
</html>
