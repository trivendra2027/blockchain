<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Seal Verified Product - QR Seal Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/web3@1.7.4/dist/web3.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>
<style>
  body {
    background: #272833;
    color: #eee;
    font-family: Arial, sans-serif;
    max-width: 580px;
    margin: auto;
    padding: 16px;
  }
  button, input {
    font-size: 1rem;
    margin: 6px 0;
    padding: 8px;
    width: 100%;
    border-radius: 6px;
    border: none;
  }
  #qr-reader {
    margin-top: 10px;
  }
  .success {
    color: #4caf50;
    margin-top: 12px;
  }
  .error {
    color: #f44336;
    margin-top: 12px;
  }
</style>
</head>
<body>

<h1>Seal Verified Product - QR Seal Tracker</h1>

<button id="connectWalletBtn">Connect Wallet</button>
<p id="walletAddress"></p>

<hr>

<section>
  <h2>Register Product with Seal QR (Owner Only)</h2>
  <input type="text" id="reg-packageQR" placeholder="Package Seal QR Code (unique)" />
  <input type="text" id="reg-name" placeholder="Product Name" />
  <input type="text" id="reg-manufacturer" placeholder="Manufacturer" />
  <input type="date" id="reg-manufactureDate" placeholder="Manufacture Date" />
  <button id="reg-btn">Register Product + Seal</button>
  <p id="reg-status"></p>
</section>

<hr>

<section>
  <h2>Verify Seal (Before Delivery)</h2>
  <input type="text" id="verify-packageQR" placeholder="Scan or Enter Package Seal QR" />
  <button id="verify-btn">Verify Seal Status</button>
  <p id="verify-status"></p>
</section>

<hr>

<section>
  <h2>Open Seal (Delivery Mark)</h2>
  <input type="text" id="open-packageQR" placeholder="Scan or Enter Package Seal QR" />
  <button id="open-btn">Open Seal (Mark Broken)</button>
  <p id="open-status"></p>
</section>

<hr>

<section>
  <h2>QR Code Scanner</h2>
  <button id="start-camera-btn">Start Camera to Scan QR</button>
  <div id="qr-reader" style="width:100%;"></div>
  <p>Scanned QR will be filled automatically in verification or other inputs.</p>
</section>

<script>
(async () => {
  // Replace these with your deployed contract info
  const contractABI = [
    {
      "inputs": [
        {"internalType":"string","name":"packageQR","type":"string"},
        {"internalType":"string","name":"name","type":"string"},
        {"internalType":"string","name":"manufacturer","type":"string"},
        {"internalType":"uint256","name":"manufactureDate","type":"uint256"}
      ],
      "name":"registerProduct",
      "outputs":[],
      "stateMutability":"nonpayable",
      "type":"function"
    },
    {
      "inputs": [{"internalType":"string","name":"packageQR","type":"string"}],
      "name":"verifySeal",
      "outputs":[
        {"internalType":"bool","name":"exists","type":"bool"},
        {"internalType":"string","name":"name","type":"string"},
        {"internalType":"string","name":"manufacturer","type":"string"},
        {"internalType":"uint256","name":"manufactureDate","type":"uint256"},
        {"internalType":"bool","name":"sealOpened","type":"bool"}
      ],
      "stateMutability":"view",
      "type":"function"
    },
    {
      "inputs": [{"internalType":"string","name":"packageQR","type":"string"}],
      "name":"openSeal",
      "outputs":[],
      "stateMutability":"nonpayable",
      "type":"function"
    }
  ];

  const contractAddress = "0xYourContractAddressHere"; // update this

  // Elements
  const connectWalletBtn = document.getElementById("connectWalletBtn");
  const walletAddressP = document.getElementById("walletAddress");
  const regPackageQRInput = document.getElementById("reg-packageQR");
  const regNameInput = document.getElementById("reg-name");
  const regManuInput = document.getElementById("reg-manufacturer");
  const regDateInput = document.getElementById("reg-manufactureDate");
  const regBtn = document.getElementById("reg-btn");
  const regStatus = document.getElementById("reg-status");

  const verifyPackageQRInput = document.getElementById("verify-packageQR");
  const verifyBtn = document.getElementById("verify-btn");
  const verifyStatus = document.getElementById("verify-status");

  const openPackageQRInput = document.getElementById("open-packageQR");
  const openBtn = document.getElementById("open-btn");
  const openStatus = document.getElementById("open-status");

  const startCameraBtn = document.getElementById("start-camera-btn");
  const qrReaderDiv = document.getElementById("qr-reader");

  let web3, contract, account;

  // Connect wallet
  connectWalletBtn.onclick = async () => {
    if (window.ethereum) {
      try {
        web3 = new Web3(window.ethereum);
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        account = accounts[0];
        walletAddressP.textContent = "Connected: " + account;
        contract = new web3.eth.Contract(contractABI, contractAddress);
      } catch (e) {
        alert("Wallet connection failed: "+e.message);
      }
    } else {
      alert("Please install MetaMask");
    }
  };

  // Register product + seal
  regBtn.onclick = async () => {
    if (!contract || !account) {
      alert("Connect wallet first.");
      return;
    }
    const packageQR = regPackageQRInput.value.trim();
    const name = regNameInput.value.trim();
    const manufacturer = regManuInput.value.trim();
    const manufactureDateStr = regDateInput.value;
    if (!packageQR || !name || !manufacturer || !manufactureDateStr) {
      regStatus.textContent = "Fill all fields!";
      regStatus.className = "error";
      return;
    }
    const manufactureDate = Math.floor(new Date(manufactureDateStr).getTime()/1000);
    try {
      regStatus.textContent = "Registering...";
      await contract.methods.registerProduct(packageQR, name, manufacturer, manufactureDate)
        .send({ from: account });
      regStatus.textContent = "✅ Registered successfully.";
      regStatus.className = "success";
    } catch (e) {
      regStatus.textContent = "Registration failed: " + e.message;
      regStatus.className = "error";
    }
  };

  // Verify seal (before delivery)
  verifyBtn.onclick = async () => {
    if (!contract || !account) {
      alert("Connect wallet first.");
      return;
    }
    const packageQR = verifyPackageQRInput.value.trim();
    if (!packageQR) {
      verifyStatus.textContent = "Enter package QR to verify.";
      verifyStatus.className = "error";
      return;
    }
    try {
      verifyStatus.textContent = "Verifying...";
      const res = await contract.methods.verifySeal(packageQR).call();
      // res = [exists, name, manufacturer, manufactureDate, sealOpened]
      if (res.exists) {
        let txt = Product Name: ${res.name}\nManufacturer: ${res.manufacturer}\nManufacture Date: ${new Date(res.manufactureDate * 1000).toLocaleDateString()}\n;
        txt += res.sealOpened ? "❌ Seal Broken - Package tampered\n" : "✅ Seal Intact - Package sealed";
        verifyStatus.textContent = txt;
        verifyStatus.className = res.sealOpened ? "error" : "success";
      } else {
        verifyStatus.textContent = "Package QR not found.";
        verifyStatus.className = "error";
      }
    } catch (e) {
      verifyStatus.textContent = "Verification error: " + e.message;
      verifyStatus.className = "error";
    }
  };

  // Open seal (mark seal opened at delivery)
  openBtn.onclick = async () => {
    if (!contract || !account) {
      alert("Connect wallet first.");
      return;
    }
    const packageQR = openPackageQRInput.value.trim();
    if (!packageQR) {
      openStatus.textContent = "Enter package QR to open seal.";
      openStatus.className = "error";
      return;
    }
    try {
      openStatus.textContent = "Opening seal...";
      await contract.methods.openSeal(packageQR).send({ from: account });
      openStatus.textContent = "✅ Seal marked as opened.";
      openStatus.className = "success";
    } catch (e) {
      openStatus.textContent = "Failed to open seal: " + e.message;
      openStatus.className = "error";
    }
  };

  // QR Scanner
  let html5QrcodeScanner;
  startCameraBtn.onclick = async () => {
    startCameraBtn.disabled = true;
    qrReaderDiv.innerHTML = "";
    html5QrcodeScanner = new Html5Qrcode("qr-reader");
    try {
      const devices = await Html5Qrcode.getCameras();
      if (devices && devices.length) {
        const backCamera = devices.find(cam => cam.label.toLowerCase().includes("back")) || devices[0];
        await html5QrcodeScanner.start(
          { deviceId: { exact: backCamera.id } },
          { fps: 10, qrbox: 250 },
          qrCodeMessage => {
            // Stop scanning once decoded
            html5QrcodeScanner.stop();
            startCameraBtn.disabled = false;
            qrReaderDiv.innerHTML = <b>Scanned QR:</b> ${qrCodeMessage};
            // Fill all QR inputs with scanned code for convenience
            regPackageQRInput.value = qrCodeMessage;
            verifyPackageQRInput.value = qrCodeMessage;
            openPackageQRInput.value = qrCodeMessage;
          },
          errorMessage => {
            // ignore or log scan errors silently
          }
        );
      } else {
        qrReaderDiv.textContent = "No camera devices found.";
        startCameraBtn.disabled = false;
      }
    } catch (err) {
      qrReaderDiv.textContent = "Camera start failed: " + err;
      startCameraBtn.disabled = false;
    }
  };
})();
</script>
</body>
</html>
