<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Blockchain Product Verification</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/web3@1.7.4/dist/web3.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f5f5f5;
      max-width: 600px;
      margin: auto;
    }
    h1, h2 {
      text-align: center;
    }
    section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    input, button {
      width: 100%;
      margin-top: 10px;
      padding: 10px;
      font-size: 16px;
    }
    #qr-reader {
      width: 100%;
      margin-top: 15px;
    }
    #verification-result {
      margin-top: 15px;
      padding: 10px;
      border-radius: 5px;
    }
    .success {
      background: #d4edda;
      color: #155724;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
    }
    #connectWalletBtn {
      background-color: #28a745;
      color: white;
    }
  </style>
</head>
<body>

  <h1>Product Registry</h1>
  <button id="connectWalletBtn">üîó Connect Wallet</button>
  <p id="walletAddress"></p>

  <section>
    <h2>Verify Product</h2>
    <input type="text" id="verify-productId" placeholder="Scan or enter product ID" autocomplete="off" />
    <button id="verify-btn" disabled>Verify Product</button>
    <div id="verification-result"></div>
    <div id="qr-reader"></div>
  </section>

  <script>
    const contractABI = [/* Your contract ABI here */];
    const contractAddress = "0x0fC5025C764cE34df352757e82f7B5c4Df39A836";

    let web3, contract, userAccount;

    const verifyInput = document.getElementById('verify-productId');
    const verifyBtn = document.getElementById('verify-btn');
    const verificationResult = document.getElementById('verification-result');

    // Connect Wallet
    document.getElementById("connectWalletBtn").addEventListener("click", async () => {
      if (typeof window.ethereum !== 'undefined') {
        try {
          web3 = new Web3(window.ethereum);
          const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
          userAccount = accounts[0];
          document.getElementById("walletAddress").innerText = "Connected: " + userAccount;
          contract = new web3.eth.Contract(contractABI, contractAddress);
          verifyBtn.disabled = false;
        } catch (err) {
          alert("Wallet connection rejected.");
        }
      } else {
        alert("Please install MetaMask.");
      }
    });

    // Verify product
    verifyBtn.addEventListener('click', async () => {
      const productId = verifyInput.value.trim();
      verificationResult.textContent = "";
      verificationResult.className = "";
      if (!productId) {
        alert("Enter or scan product ID.");
        return;
      }
      try {
        const result = await contract.methods.verifyProduct(productId).call({ from: userAccount });
        if (result[0]) {
          verificationResult.innerHTML = `<strong>‚úîÔ∏è Authentic Product</strong><br>
            <strong>Name:</strong> ${escapeHtml(result[1])}<br>
            <strong>Manufacturer:</strong> ${escapeHtml(result[2])}`;
          verificationResult.className = "success";
        } else {
          verificationResult.textContent = "‚ùå Product not found or counterfeit.";
          verificationResult.className = "error";
        }
      } catch (err) {
        verificationResult.textContent = "Error verifying product.";
        verificationResult.className = "error";
      }
    });

    function escapeHtml(text) {
      if (!text) return '';
      return text.replace(/[&<>"']/g, (m) => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;',
      })[m]);
    }

    // QR Scanner Setup (Always on)
    const qrCodeRegionId = "qr-reader";
    const html5QrCode = new Html5Qrcode(qrCodeRegionId);

    function onScanSuccess(decodedText) {
      verifyInput.value = decodedText;
      verificationResult.textContent = "";
      verificationResult.className = "";
    }

    function onScanFailure(error) {
      // Failures silently ignored
    }

    Html5Qrcode.getCameras().then(cameras => {
      if (cameras && cameras.length) {
        const cam = cameras.find(c => c.label.toLowerCase().includes('back')) || cameras[0];
        html5QrCode.start(
          cam.id,
          { fps: 10, qrbox: 250 },
          onScanSuccess,
          onScanFailure
        ).catch(err => {
          console.error("Camera start failed:", err);
        });
      } else {
        alert("No camera found.");
      }
    }).catch(err => {
      alert("Camera access error: " + err);
    });
  </script>
</body>
</html>
