<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Product Registry</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #d0eaff, #f6f8fa);
      color: #333;
      padding: 20px;
    }
    h1 { color: #0077cc; }
    input, button {
      padding: 8px;
      margin: 5px 0;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      background: #0077cc;
      color: white;
      border: none;
      cursor: pointer;
    }
    #scanner { width: 100%; margin-top: 10px; }
    .section { margin-bottom: 30px; }
  </style>
</head>
<body>

<h1>üîí Product Registry System</h1>

<div class="section">
  <h2>üì∑ Scan Barcode</h2>
  <div id="scanner"></div>
  <p><strong>Scanned Product ID:</strong> <span id="scannedResult">None</span></p>
</div>

<div class="section">
  <h2>üìù Register Product</h2>
  <input type="text" id="regProductId" placeholder="Product ID" />
  <input type="text" id="regName" placeholder="Product Name" />
  <input type="text" id="regManufacturer" placeholder="Manufacturer" />
  <input type="date" id="regDate" />
  <button onclick="registerProduct()">Register</button>
  <p id="regStatus"></p>
</div>

<div class="section">
  <h2>üîç Verify Product</h2>
  <input type="text" id="verifyProductId" placeholder="Enter or Scan Product ID" />
  <button onclick="verifyProduct()">Verify</button>
  <div id="verifyResult"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.10.0/web3.min.js"></script>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
  const contractAddress = "0x9D7f74d0C41E726EC95884E0e97Fa6129e3b5E99";
  const contractABI = [
    {
      "anonymous": false,
      "inputs": [
        { "indexed": false, "internalType": "string", "name": "productId", "type": "string" },
        { "indexed": false, "internalType": "string", "name": "name", "type": "string" },
        { "indexed": false, "internalType": "string", "name": "manufacturer", "type": "string" }
      ],
      "name": "ProductRegistered",
      "type": "event"
    },
    {
      "inputs": [
        { "internalType": "string", "name": "productId", "type": "string" },
        { "internalType": "string", "name": "name", "type": "string" },
        { "internalType": "string", "name": "manufacturer", "type": "string" },
        { "internalType": "uint256", "name": "mDate", "type": "uint256" }
      ],
      "name": "registerProduct",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    },
    {
      "inputs": [
        { "internalType": "string", "name": "productId", "type": "string" }
      ],
      "name": "verifyProduct",
      "outputs": [
        { "internalType": "bool", "name": "exists", "type": "bool" },
        { "internalType": "string", "name": "name", "type": "string" },
        { "internalType": "string", "name": "manufacturer", "type": "string" }
      ],
      "stateMutability": "view",
      "type": "function"
    }
  ];

  const web3 = new Web3(Web3.givenProvider || "http://127.0.0.1:8545");
  const contract = new web3.eth.Contract(contractABI, contractAddress);

  // Set default account
  async function setDefaultAccount() {
    const accounts = await web3.eth.getAccounts();
    web3.eth.defaultAccount = accounts[0];
  }
  setDefaultAccount();

  // Register product
  async function registerProduct() {
    const id = document.getElementById("regProductId").value;
    const name = document.getElementById("regName").value;
    const mfg = document.getElementById("regManufacturer").value;
    const date = new Date(document.getElementById("regDate").value).getTime();

    try {
      await contract.methods.registerProduct(id, name, mfg, date).send({ from: web3.eth.defaultAccount });
      document.getElementById("regStatus").innerText = "‚úÖ Product registered!";
    } catch (err) {
      document.getElementById("regStatus").innerText = "‚ùå Error: " + err.message;
    }
  }

  // Verify product
  async function verifyProduct() {
    const id = document.getElementById("verifyProductId").value;
    try {
      const result = await contract.methods.verifyProduct(id).call();
      if (result.exists) {
        document.getElementById("verifyResult").innerHTML =
          `<p>‚úÖ Product Found:</p>
           <p><b>Name:</b> ${result.name}</p>
           <p><b>Manufacturer:</b> ${result.manufacturer}</p>`;
      } else {
        document.getElementById("verifyResult").innerText = "‚ùå Product not found!";
      }
    } catch (err) {
      document.getElementById("verifyResult").innerText = "‚ùå Error: " + err.message;
    }
  }

  // Barcode scanner
  const html5QrCode = new Html5Qrcode("scanner");
  html5QrCode.start(
    { facingMode: "environment" },
    {
      fps: 10,
      qrbox: 250
    },
    qrCodeMessage => {
      document.getElementById("scannedResult").innerText = qrCodeMessage;
      document.getElementById("regProductId").value = qrCodeMessage;
      document.getElementById("verifyProductId").value = qrCodeMessage;
    },
    errorMessage => {
      // Ignore decode errors
    }
  ).catch(err => {
    document.getElementById("scanner").innerText = "Camera Error: " + err;
  });
</script>

</body>
</html>
